#!/usr/bin/env python3
import sys, os, threading, time
import cv2
import numpy as np
from PyQt5.QtWidgets import QApplication, QWidget, QLabel, QPushButton, QVBoxLayout, QHBoxLayout
from PyQt5.QtGui import QImage, QPixmap
from PyQt5.QtCore import Qt, QRect
from gpiozero import LED
from ultralytics import YOLO

# ====== SETTINGS ======
MODEL_PATH = "/home/root1/yolov8l.engine"   # TensorRT engine
ALARM_PIN = 18                              # GPIO output (LOW = alert)
CAM_INDEX = 0
# =======================

# Initialize GPIO (default HIGH = no alert)
alarm = LED(ALARM_PIN)
alarm.on()

# ---------- Detection thread ----------
class DetectorThread(threading.Thread):
    def __init__(self, callback):
        super().__init__()
        self.model = YOLO(MODEL_PATH)
        self.callback = callback
        self.running = True
        self.cap = cv2.VideoCapture(CAM_INDEX, cv2.CAP_V4L2)
        self.cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
        self.cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
        self.geofence = None
        self.show_fence = True

    def run(self):
        fps_time = time.time()
        frame_count = 0
        while self.running:
            ret, frame = self.cap.read()
            if not ret:
                continue

            # Inference (people only)
            results = self.model.predict(frame, classes=[0], device=0, verbose=False)
            humans = []
            if len(results) and results[0].boxes is not None:
                for box in results[0].boxes.xyxy.cpu().numpy():
                    humans.append(tuple(map(int, box)))

            # Check geofence alert
            alert = False
            if self.geofence is not None:
                x1, y1, x2, y2 = self.geofence
                fence_rect = QRect(x1, y1, x2 - x1, y2 - y1)
                for (a, b, c, d) in humans:
                    if fence_rect.intersects(QRect(a, b, c - a, d - b)):
                        alert = True
                        break

            # GPIO output
            if alert:
                alarm.off()   # LOW
            else:
                alarm.on()    # HIGH

            # Draw overlays
            for (a, b, c, d) in humans:
                cv2.rectangle(frame, (a, b), (c, d), (0, 255, 0), 2)
            if self.show_fence and self.geofence is not None:
                cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 0, 255), 2)

            frame_count += 1
            now = time.time()
            if now - fps_time >= 1:
                fps = frame_count
                fps_time = now
                frame_count = 0
            else:
                fps = None

            self.callback(frame, len(humans), alert, fps)

        self.cap.release()

    def stop(self):
        self.running = False

# ---------- GUI ----------
class MainWindow(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("AI Security System - Jetson")
        self.setGeometry(100, 100, 1200, 650)

        layout = QHBoxLayout(self)

        # Left info panel
        left = QVBoxLayout()
        self.status = QLabel("Status: âœ… CLEAR")
        self.status.setStyleSheet("font-size:20px;color:green;font-weight:bold;")
        self.count = QLabel("People: 0")
        self.fps_label = QLabel("FPS: 0")
        self.time_label = QLabel("Last: --")
        self.geo_btn = QPushButton("Toggle Geofence")
        self.geo_btn.clicked.connect(self.toggle_fence)

        for w in [self.status, self.count, self.fps_label, self.time_label, self.geo_btn]:
            left.addWidget(w)
        left.addStretch()

        left_widget = QWidget()
        left_widget.setLayout(left)
        left_widget.setFixedWidth(300)
        layout.addWidget(left_widget)

        # Video feed area
        self.video_label = QLabel()
        self.video_label.setStyleSheet("background:black;")
        layout.addWidget(self.video_label)

        # Start detection
        self.thread = DetectorThread(self.update_frame)
        self.thread.start()

        self.drawing = False
        self.fence_start = None
        self.video_label.mousePressEvent = self.start_draw
        self.video_label.mouseReleaseEvent = self.end_draw
        self.video_label.mouseMoveEvent = self.move_draw

    # --- Update video ---
    def update_frame(self, frame, count, alert, fps):
        rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
        h, w, ch = rgb.shape
        img = QImage(rgb.data, w, h, ch * w, QImage.Format_RGB888)
        self.video_label.setPixmap(QPixmap.fromImage(img))

        self.count.setText(f"People: {count}")
        if fps:
            self.fps_label.setText(f"FPS: {fps}")
        if alert:
            self.status.setText("ðŸš¨ HUMAN IN FENCE")
            self.status.setStyleSheet("font-size:20px;color:red;font-weight:bold;")
            self.time_label.setText(time.strftime("Last: %H:%M:%S"))
        else:
            self.status.setText("Status: âœ… CLEAR")
            self.status.setStyleSheet("font-size:20px;color:green;font-weight:bold;")

    # --- Mouse geofence drawing ---
    def start_draw(self, e):
        self.drawing = True
        self.fence_start = (e.x(), e.y())

    def move_draw(self, e):
        if self.drawing:
            self.thread.geofence = (self.fence_start[0], self.fence_start[1], e.x(), e.y())

    def end_draw(self, e):
        self.drawing = False

    def toggle_fence(self):
        self.thread.show_fence = not self.thread.show_fence

    def closeEvent(self, e):
        self.thread.stop()
        alarm.on()
        e.accept()

if __name__ == "__main__":
    os.environ.setdefault("DISPLAY", ":0")
    os.environ.setdefault("XAUTHORITY", "/home/root1/.Xauthority")
    app = QApplication(sys.argv)
    win = MainWindow()
    win.show()
    sys.exit(app.exec_())
